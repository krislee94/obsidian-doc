# Manage events with service workers


* 例如导航到新页面、删除书签或关闭选项卡。[扩展使用后台服务工作者](https://developer.chrome.com/docs/extensions/mv3/migrating_to_service_workers/)中的脚本监视这些事件，然后根据指定的指令做出反应。


后台工作需要加载，在空闲时卸载。

* 扩展首先安装或更新到新版
* 后台页面正在侦听一个事件，并且该事件已被调度。
* 内容脚本或其他扩展[会发送消息。](https://developer.chrome.com/docs/extensions/mv3/messaging/)
* 扩展中的另一个视图，例如弹出窗口，调用[`runtime.getBackgroundPage`](https://developer.chrome.com/docs/extensions/runtime#method-getBackgroundPage).


## 步骤

1.   注册background scripts

> 在 manifest.json里注册，且scripts的js文件必须在根目录下面

```json
{  "name": "Awesome Test Extension",  ...  "background": {    "service_worker": "background.js"  },  ...}
```

2. 您可以选择指定一个额外的字段，`"type": "module"`以将服务工作者包含为 ES 模块，这允许您`import`进一步编码。


```json
  "background": {
    "service_worker": "background.js",
    "type": "module"
  }

```

收听[`runtime.onInstalled`](https://developer.chrome.com/docs/extensions/reference/runtime#event-onInstalled)事件以在安装时初始化扩展。使用此事件设置状态或一次性初始化，例如[上下文菜单](https://developer.chrome.com/docs/extensions/reference/contextMenus/)。


eg:

```js
chrome.runtime.onInstalled.addListener(() => {
  chrome.contextMenus.create({
    "id": "sampleContextMenu",
    "title": "Sample Context Menu",
    "contexts": ["selection"]
  });
});


```


3. 设置监听器

围绕扩展所依赖的事件构建背景脚本。定义功能相关的事件允许后台脚本处于休眠状态，直到这些事件被触发，并防止扩展丢失重要的触发器。

侦听器必须从页面开始同步注册。


```js
chrome.runtime.onInstalled.addListener(() => {
  chrome.contextMenus.create({
    "id": "sampleContextMenu",
    "title": "Sample Context Menu",
    "contexts": ["selection"],
  });
});

// This will run when a bookmark is created.
chrome.bookmarks.onCreated.addListener(() => {
  // do something
});


```

> 不要使用异步，这会导致监听不会正确的被触发。


删除 监听器

```js
chrome.runtime.onMessage.addListener((message, sender, reply) => {
  chrome.runtime.onMessage.removeListener(event);
});

```

